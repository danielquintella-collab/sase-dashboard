name: Atualizar Dashboard SASE

on:
  schedule:
    - cron: '0 2 * * *'  # 23h Rio de Janeiro (02:00 UTC)
  workflow_dispatch:  # Permite rodar manualmente

jobs:
  update-dashboard:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Clonar o reposit√≥rio
      - name: üì• Clonar reposit√≥rio
        uses: actions/checkout@v3
      
      # Step 2: Configurar Python
      - name: üêç Configurar Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      # Step 3: Instalar depend√™ncias
      - name: üì¶ Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install pandas openpyxl google-auth-oauthlib google-auth-httplib2 google-api-python-client requests
      
      # Step 4: Executar script de atualiza√ß√£o
      - name: üîÑ Executar script de atualiza√ß√£o
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: python scripts/update.py
      
      # Step 5: Commit e Push das mudan√ßas com token pessoal
      - name: üíæ Commit e Push das mudan√ßas
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          git add dashboard.html
          git commit -m "ü§ñ Dashboard atualizado automaticamente - $(date -u +'%Y-%m-%d %H:%M:%S UTC')" || true
          git push https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }} HEAD:main
      
      # Step 6: Notificar sucesso
      - name: ‚úÖ Notifica√ß√£o de Sucesso
        if: success()
        run: echo "Dashboard atualizado com sucesso √†s $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
      
      # Step 7: Notificar erro
      - name: ‚ùå Notifica√ß√£o de Erro
        if: failure()
        run: echo "Erro na atualiza√ß√£o do dashboard. Verifique os logs."
